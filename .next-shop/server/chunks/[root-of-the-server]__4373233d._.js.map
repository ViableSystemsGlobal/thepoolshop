{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 3, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 61, "column": 0}, "map": {"version":3,"sources":["file:///Users/nanasasu/Desktop/adpoolsgroup/src/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from '@prisma/client'\n\nconst globalForPrisma = globalThis as unknown as {\n  prisma: PrismaClient | undefined\n}\n\nexport const prisma = globalForPrisma.prisma ?? new PrismaClient()\n\nif (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,kBAAkB;AAIjB,MAAM,SAAS,gBAAgB,MAAM,IAAI,IAAI,6IAAY;AAEhE,wCAA2C,gBAAgB,MAAM,GAAG","debugId":null}},
    {"offset": {"line": 74, "column": 0}, "map": {"version":3,"sources":["file:///Users/nanasasu/Desktop/adpoolsgroup/src/app/api/public/shop/checkout/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\nimport { prisma } from \"@/lib/prisma\";\nimport { cookies } from \"next/headers\";\n\n// Helper to generate order number\nfunction generateOrderNumber(): string {\n  const prefix = \"ORD\";\n  const timestamp = Date.now().toString(36).toUpperCase();\n  const random = Math.random().toString(36).substring(2, 5).toUpperCase();\n  return `${prefix}-${timestamp}-${random}`;\n}\n\n// POST /api/public/shop/checkout - Process checkout\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json();\n    const {\n      customer,\n      shippingAddress,\n      billingAddress,\n      paymentMethod = \"CASH\",\n      notes,\n    } = body;\n\n    // Validate required fields\n    if (!customer || !customer.email || !customer.name) {\n      return NextResponse.json(\n        { error: \"Customer information is required\" },\n        { status: 400 }\n      );\n    }\n\n    if (!shippingAddress) {\n      return NextResponse.json(\n        { error: \"Shipping address is required\" },\n        { status: 400 }\n      );\n    }\n\n    // Get cart session\n    const cookieStore = await cookies();\n    const cartId = cookieStore.get(\"cart_session\")?.value;\n    \n    if (!cartId) {\n      return NextResponse.json(\n        { error: \"No cart found\" },\n        { status: 400 }\n      );\n    }\n\n    const cartData = cookieStore.get(`cart_${cartId}`)?.value;\n    \n    if (!cartData) {\n      return NextResponse.json(\n        { error: \"Cart is empty\" },\n        { status: 400 }\n      );\n    }\n\n    const cart = JSON.parse(cartData);\n    \n    if (!cart.items || cart.items.length === 0) {\n      return NextResponse.json(\n        { error: \"Cart is empty\" },\n        { status: 400 }\n      );\n    }\n\n    // Start transaction\n    const result = await prisma.$transaction(async (tx) => {\n      // Check if customer exists or create new lead\n      let lead = await tx.lead.findFirst({\n        where: {\n          email: customer.email,\n        },\n      });\n\n      // Get default system user (for owner assignment) - moved outside if block\n      let systemUser = await tx.user.findFirst({\n        where: {\n          OR: [\n            { role: \"ADMIN\" },\n            { role: \"SUPER_ADMIN\" }\n          ]\n        },\n      });\n\n      // If no admin user found, create a default one\n      if (!systemUser) {\n        systemUser = await tx.user.create({\n          data: {\n            email: \"system@thepoolshop.africa\",\n            name: \"System User\",\n            role: \"ADMIN\",\n          },\n        });\n      }\n\n      if (!lead) {\n        // Create new lead from customer\n        const [firstName, ...lastNameParts] = customer.name.split(\" \");\n        const lastName = lastNameParts.join(\" \") || firstName;\n\n        lead = await tx.lead.create({\n          data: {\n            firstName,\n            lastName,\n            email: customer.email,\n            phone: customer.phone || \"\",\n            company: customer.company,\n            status: \"NEW\",\n            leadType: \"INDIVIDUAL\",\n            source: \"ECOMMERCE\",\n            subject: \"Online Store Customer\",\n            ownerId: systemUser ? systemUser.id : \"system\",\n            billingAddress: billingAddress || shippingAddress,\n            shippingAddress: shippingAddress,\n            hasBillingAddress: true,\n            hasShippingAddress: true,\n            sameAsBilling: !billingAddress,\n          },\n        });\n      }\n\n      // Create quotation from cart\n      const quotationNumber = `QT-${Date.now().toString(36).toUpperCase()}`;\n      \n      // Calculate totals\n      let subtotal = 0;\n      const quotationLines = [];\n      \n      for (const item of cart.items) {\n        const product = await tx.product.findUnique({\n          where: { id: item.productId },\n          include: { stockItems: true },\n        });\n\n        if (!product) {\n          throw new Error(`Product ${item.productId} not found`);\n        }\n\n        const totalStock = product.stockItems.reduce(\n          (sum, si) => sum + si.available,\n          0\n        );\n\n        if (totalStock < item.quantity) {\n          throw new Error(\n            `Insufficient stock for ${product.name}. Available: ${totalStock}, Requested: ${item.quantity}`\n          );\n        }\n\n        const lineTotal = (product.price || 0) * item.quantity;\n        subtotal += lineTotal;\n\n        quotationLines.push({\n          productId: product.id,\n          quantity: item.quantity,\n          unitPrice: product.price || 0,\n          discount: 0,\n          lineTotal,\n        });\n      }\n\n      const tax = subtotal * 0.125; // 12.5% VAT\n      const total = subtotal + tax;\n\n\n      // Create quotation\n      const quotation = await tx.quotation.create({\n        data: {\n          number: quotationNumber,\n          status: \"SENT\",\n          subject: `Online Order - ${customer.name}`,\n          validUntil: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000), // 30 days\n          notes: notes || \"Order placed via online store\",\n          currency: \"GHS\",\n          subtotal,\n          tax,\n          total,\n          taxInclusive: true,\n          leadId: lead.id,\n          ownerId: systemUser ? systemUser.id : \"system\",\n          customerType: \"STANDARD\",\n          billingAddressSnapshot: billingAddress || shippingAddress,\n          shippingAddressSnapshot: shippingAddress,\n          lines: {\n            create: quotationLines,\n          },\n        },\n        include: {\n          lines: {\n            include: {\n              product: true,\n            },\n          },\n        },\n      });\n\n      // Create invoice from quotation\n      const invoiceNumber = `INV-${Date.now().toString(36).toUpperCase()}`;\n      \n      const invoice = await tx.invoice.create({\n        data: {\n          number: invoiceNumber,\n          subject: `Invoice - ${customer.name}`,\n          quotationId: quotation.id,\n          leadId: lead.id,\n          status: \"SENT\",\n          paymentStatus: paymentMethod === \"CASH\" ? \"UNPAID\" : \"UNPAID\",\n          issueDate: new Date(),\n          dueDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000), // 7 days\n          currency: \"GHS\",\n          subtotal,\n          tax,\n          discount: 0,\n          total,\n          amountPaid: 0,\n          amountDue: total,\n          taxInclusive: true,\n          paymentTerms: \"Net 7 days\",\n          customerType: \"STANDARD\",\n          billingAddressSnapshot: billingAddress || shippingAddress,\n          shippingAddressSnapshot: shippingAddress,\n          notes: `Payment Method: ${paymentMethod}\\n${notes || \"\"}`,\n          ownerId: systemUser ? systemUser.id : \"system\",\n          lines: {\n            create: quotationLines.map(line => ({\n              productId: line.productId,\n              quantity: line.quantity,\n              unitPrice: line.unitPrice,\n              discount: line.discount,\n              lineTotal: line.lineTotal,\n            })),\n          },\n        },\n        include: {\n          lines: {\n            include: {\n              product: true,\n            },\n          },\n        },\n      });\n\n      // Update stock levels\n      for (const item of cart.items) {\n        // Get stock items for the product\n        const stockItems = await tx.stockItem.findMany({\n          where: {\n            productId: item.productId,\n            available: { gt: 0 },\n          },\n          orderBy: {\n            available: \"asc\", // Use items with less stock first (FIFO-ish)\n          },\n        });\n\n        let remainingQuantity = item.quantity;\n\n        for (const stockItem of stockItems) {\n          if (remainingQuantity <= 0) break;\n\n          const quantityToDeduct = Math.min(\n            remainingQuantity,\n            stockItem.available\n          );\n\n          // Update stock item\n          await tx.stockItem.update({\n            where: { id: stockItem.id },\n            data: {\n              available: stockItem.available - quantityToDeduct,\n              reserved: stockItem.reserved + quantityToDeduct,\n            },\n          });\n\n          // Create stock movement\n          await tx.stockMovement.create({\n            data: {\n              productId: item.productId,\n              stockItemId: stockItem.id,\n              type: \"SALE\",\n              quantity: -quantityToDeduct,\n              reference: invoice.number,\n              reason: \"Online store sale\",\n              notes: \"Invoice: \" + invoice.number,\n              warehouseId: stockItem.warehouseId,\n            },\n          });\n\n          remainingQuantity -= quantityToDeduct;\n        }\n      }\n\n      return {\n        quotation,\n        invoice,\n        lead,\n      };\n    });\n\n    // Clear the cart after successful transaction\n    const clearCookieStore = await cookies();\n    clearCookieStore.delete(`cart_${cartId}`);\n\n    return NextResponse.json({\n      success: true,\n      message: \"Order placed successfully\",\n      order: {\n        quotationNumber: result.quotation.number,\n        invoiceNumber: result.invoice.number,\n        total: result.invoice.total,\n        currency: result.invoice.currency,\n        status: \"PROCESSING\",\n      },\n    });\n  } catch (error) {\n    console.error(\"Checkout error:\", error);\n    return NextResponse.json(\n      { \n        error: error instanceof Error ? error.message : \"Checkout failed\"\n      },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}